name: Deploy prod Infra Definitions

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  AWS_IAM_ROLE: arn:aws:iam::265507129563:role/role-github-actions-eodi

jobs:
  deploy-prod-infra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for history)
        uses: actions/checkout@v4

      - name: Configure AWS credentials - OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync prod infra to server
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets \
              "Key=tag:project,Values=eodi" \
              "Key=tag:phase,Values=prod" \
              "Key=tag:role,Values=app" \
            --comment "Deploy prod infra definitions" \
            --parameters '{
              "commands": [
                "set -e",
                "INFRA_DIR=/opt/eodi/infra",
                "REPO_URL=https://github.com/bbyuk/eodi-infra.git",
                "",
                "echo \"[INFO] Checking infra directory...\"",
                "",
                "if [ ! -d \"$INFRA_DIR\" ]; then",
                "  echo \"[INFO] infra directory not found. Cloning repository...\"",
                "  mkdir -p /opt/eodi",
                "  cd /opt/eodi",
                "  git clone $REPO_URL infra",
                "else",
                "  cd $INFRA_DIR",
                "",
                "  if [ ! -d .git ]; then",
                "    echo \"[WARN] infra exists but is not a git repository. Re-cloning...\"",
                "    cd /opt/eodi",
                "    rm -rf infra",
                "    git clone $REPO_URL infra",
                "  else",
                "    ORIGIN_URL=$(git remote get-url origin || echo \"\")",
                "",
                "    if [ \"$ORIGIN_URL\" != \"$REPO_URL\" ]; then",
                "      echo \"[WARN] infra git remote mismatch ($ORIGIN_URL). Re-cloning...\"",
                "      cd /opt/eodi",
                "      rm -rf infra",
                "      git clone $REPO_URL infra",
                "    else",
                "      echo \"[INFO] infra repository is valid. Updating...\"",
                "      git fetch origin",
                "      git reset --hard origin/main",
                "    fi",
                "  fi",
                "fi",
                "echo \"[INFO] Fixing ownership...\"",
                "chown -R ubuntu:ubuntu /opt/eodi"
              ]
            }'

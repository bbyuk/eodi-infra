name: Prod alloy docker compose up

on:
  workflow_dispatch:

permissions:
  id-token: write # OIDC 필수
  contents: read

env:
  AWS_REGION: ap-northeast-2
  AWS_IAM_ROLE: arn:aws:iam::265507129563:role/role-github-actions-eodi

jobs:
  start-prod-alloy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for history)
        uses: actions/checkout@v4

      - name: Configure AWS credentials - OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start alloy docker compose
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets \
              "Key=tag:project,Values=eodi" \
              "Key=tag:phase,Values=prod" \
              "Key=tag:role,Values=app" \
            --comment "Start prod alloy docker compose" \
            --parameters '{
              "commands": [
                "set -e",
                "cd /opt/eodi/infra/prod/app/compose",
                "",
                "echo \"[INFO] start alloy using docker compose\"",
                "docker compose -f docker-compose.alloy.yml down",
                "docker compose -f docker-compose.base.yml -f docker-compose.alloy.yml up -d",
                "",
                "echo \"[INFO] alloy start completed\""
              ]
            }'
